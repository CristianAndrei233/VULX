generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String        @id @default(uuid())
  email               String        @unique
  passwordHash        String?
  name                String?
  stripeCustomerId    String?       @unique
  onboardingCompleted Boolean       @default(false)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  organizationId      String?
  subscription        Subscription?
  organization        Organization? @relation(fields: [organizationId], references: [id])
  role                Role          @default(USER)
}

enum Role {
  ADMIN
  USER
}

model Subscription {
  id                   String   @id @default(uuid())
  userId               String   @unique
  stripeSubscriptionId String   @unique
  stripePriceId        String
  status               String
  planId               String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  plan                 Plan     @relation(fields: [planId], references: [id])
  user                 User     @relation(fields: [userId], references: [id])
}

model Plan {
  id            String         @id @default(uuid())
  name          String
  stripePriceId String         @unique
  price         Int
  interval      String
  scansPerMonth Int
  projectLimit  Int
  features      String[]
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subscriptions Subscription[]
}

model Organization {
  id        String    @id @default(uuid())
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  projects  Project[]
  users     User[]
}

model Project {
  id             String       @id @default(uuid())
  name           String
  specUrl        String?
  specContent    String?
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])
  scans          Scan[]
  scanFrequency  ScanFrequency @default(MANUAL)
  nextScanAt     DateTime?
}

enum ScanFrequency {
  MANUAL
  DAILY
  WEEKLY
}

model Scan {
  id          String    @id @default(uuid())
  projectId   String
  status      String    @default("PENDING")
  startedAt   DateTime  @default(now())
  completedAt      DateTime?
  findings         Finding[]
  project          Project   @relation(fields: [projectId], references: [id])
  notificationSent Boolean   @default(false)
}

model Finding {
  id            String   @id @default(uuid())
  scanId        String
  type          String
  severity      String
  description   String
  endpoint      String
  method        String
  createdAt     DateTime @default(now())
  remediation   String?
  cweId         String?
  evidence      String?
  owaspCategory String?
  scan          Scan     @relation(fields: [scanId], references: [id])
}
