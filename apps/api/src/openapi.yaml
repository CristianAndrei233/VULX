openapi: 3.1.0
info:
  title: VULX SecureAPI Scanner
  description: |
    # Introduction

    VULX is an enterprise-grade API security assessment platform that analyzes OpenAPI/Swagger
    specifications against the **OWASP API Security Top 10 (2023)** framework.

    ## Features

    - **Comprehensive Security Scanning** - Detect vulnerabilities across all OWASP API Top 10 categories
    - **Professional PDF Reports** - Generate detailed security assessment reports
    - **CI/CD Integration** - Seamless integration with GitHub Actions, GitLab CI, and Jenkins
    - **Real-time Results** - Monitor scan progress and view findings instantly

    ## Authentication

    All API endpoints (except `/health`) require authentication using a Bearer token:

    ```
    Authorization: Bearer YOUR_API_KEY
    ```

    ## Rate Limiting

    API requests are rate-limited based on your subscription plan:

    | Plan | Requests/minute |
    |------|-----------------|
    | Free | 60 |
    | Pro | 300 |
    | Enterprise | Unlimited |

    ## Errors

    The API uses standard HTTP status codes:

    | Code | Description |
    |------|-------------|
    | 200 | Success |
    | 201 | Created |
    | 400 | Bad Request |
    | 401 | Unauthorized |
    | 403 | Forbidden |
    | 404 | Not Found |
    | 429 | Too Many Requests |
    | 500 | Internal Server Error |

  version: 1.0.0
  contact:
    name: VULX Support
    email: support@vulx.io
    url: https://vulx.io
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  x-logo:
    url: /assets/logo.png
    altText: VULX Logo

servers:
  - url: http://localhost:3001
    description: Local Development Server
  - url: https://api.vulx.io/v1
    description: Production Server

tags:
  - name: Health
    description: Service health and status endpoints
  - name: Projects
    description: |
      Project management endpoints. Projects contain OpenAPI specifications
      that are analyzed for security vulnerabilities.
  - name: Scans
    description: |
      Security scan operations. Trigger scans, check status, and retrieve results.
  - name: Reports
    description: Generate and download security assessment reports
  - name: Billing
    description: |
      Subscription and billing management. Powered by Stripe for secure payment processing.
  - name: Usage
    description: API usage statistics and quota management

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health Check
      description: Returns the current health status of the API service
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: ok
                service: vulx-api

  /projects:
    get:
      tags:
        - Projects
      summary: List Projects
      description: |
        Retrieves all projects belonging to the authenticated user's organization.
        Results are paginated and sorted by creation date (newest first).
      operationId: listProjects
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: List of projects
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Project'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags:
        - Projects
      summary: Create Project
      description: |
        Creates a new project with an OpenAPI specification.
        You can provide either a URL to the specification or the raw content.
      operationId: createProject
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProjectRequest'
            examples:
              withUrl:
                summary: Create with specification URL
                value:
                  name: Payment Gateway API
                  specUrl: https://api.example.com/openapi.yaml
              withContent:
                summary: Create with inline specification
                value:
                  name: User Service API
                  specContent: |
                    openapi: 3.0.0
                    info:
                      title: User Service
                      version: 1.0.0
                    paths:
                      /users:
                        get:
                          summary: List users
      responses:
        '201':
          description: Project created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{projectId}:
    get:
      tags:
        - Projects
      summary: Get Project
      description: Retrieves detailed information about a specific project including recent scans
      operationId: getProject
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectIdParam'
      responses:
        '200':
          description: Project details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectWithScans'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{projectId}/scans:
    post:
      tags:
        - Scans
      summary: Trigger Scan
      description: |
        Initiates a new security scan for the specified project.

        The scan runs asynchronously. Use the returned scan ID to poll for results
        or set up a webhook to receive notifications when the scan completes.

        ## Scan Process

        1. **PENDING** - Scan queued for processing
        2. **PROCESSING** - Scan in progress
        3. **COMPLETED** - Scan finished successfully
        4. **FAILED** - Scan encountered an error
      operationId: triggerScan
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectIdParam'
      responses:
        '201':
          description: Scan initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Scan'
              example:
                id: scan_abc123xyz
                projectId: proj_xyz789abc
                status: PENDING
                startedAt: '2024-01-15T10:30:00Z'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          description: Scan quota exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: Scan quota exceeded
                message: You have reached your monthly scan limit. Please upgrade your plan.
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{projectId}/scans/{scanId}:
    get:
      tags:
        - Scans
      summary: Get Scan Results
      description: |
        Retrieves the status and findings of a specific scan.

        If the scan is still in progress, the `findings` array will be empty.
        Poll this endpoint to check scan completion status.
      operationId: getScan
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectIdParam'
        - $ref: '#/components/parameters/ScanIdParam'
      responses:
        '200':
          description: Scan details with findings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScanWithFindings'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{projectId}/scans/{scanId}/report:
    get:
      tags:
        - Reports
      summary: Download PDF Report
      description: |
        Generates and downloads a comprehensive PDF security assessment report.

        ## Report Contents

        - **Executive Summary** - High-level overview with risk score
        - **OWASP Coverage Matrix** - Status for each API Top 10 category
        - **Detailed Findings** - Full vulnerability descriptions with evidence
        - **Remediation Roadmap** - Prioritized fix recommendations
        - **Methodology Appendix** - Scanning approach documentation
      operationId: downloadReport
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectIdParam'
        - $ref: '#/components/parameters/ScanIdParam'
      responses:
        '200':
          description: PDF report file
          content:
            application/pdf:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
              example: attachment; filename="vulx-report-scan_abc123.pdf"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /billing/plans:
    get:
      tags:
        - Billing
      summary: List Subscription Plans
      description: Retrieves all available subscription plans with pricing and features
      operationId: listPlans
      responses:
        '200':
          description: List of available plans
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Plan'
        '500':
          $ref: '#/components/responses/InternalError'

  /billing/subscription/{userId}:
    get:
      tags:
        - Billing
      summary: Get User Subscription
      description: Retrieves the current subscription details for a user
      operationId: getSubscription
      security:
        - BearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          description: User ID
      responses:
        '200':
          description: Subscription details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /billing/create-checkout-session:
    post:
      tags:
        - Billing
      summary: Create Checkout Session
      description: Creates a Stripe checkout session for subscription purchase
      operationId: createCheckoutSession
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - priceId
                - userId
              properties:
                priceId:
                  type: string
                  description: Stripe Price ID
                userId:
                  type: string
                  description: User ID
                successUrl:
                  type: string
                  format: uri
                  description: URL to redirect after successful payment
                cancelUrl:
                  type: string
                  format: uri
                  description: URL to redirect if payment is cancelled
      responses:
        '200':
          description: Checkout session created
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
                    description: Stripe Checkout Session ID
                  url:
                    type: string
                    format: uri
                    description: Checkout page URL
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /billing/create-portal-session:
    post:
      tags:
        - Billing
      summary: Create Customer Portal Session
      description: Creates a Stripe customer portal session for subscription management
      operationId: createPortalSession
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: string
                  description: User ID
                returnUrl:
                  type: string
                  format: uri
                  description: URL to return after portal session
      responses:
        '200':
          description: Portal session created
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                    format: uri
                    description: Customer portal URL
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /billing/cancel-subscription:
    post:
      tags:
        - Billing
      summary: Cancel Subscription
      description: Cancels the user's subscription at the end of the current billing period
      operationId: cancelSubscription
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: string
                  description: User ID
      responses:
        '200':
          description: Subscription cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /billing/resume-subscription:
    post:
      tags:
        - Billing
      summary: Resume Subscription
      description: Resumes a cancelled subscription before the end of the billing period
      operationId: resumeSubscription
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: string
                  description: User ID
      responses:
        '200':
          description: Subscription resumed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /billing/usage/{userId}:
    get:
      tags:
        - Usage
      summary: Get Usage Statistics
      description: Retrieves API usage statistics for the current billing period
      operationId: getUsage
      security:
        - BearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          description: User ID
      responses:
        '200':
          description: Usage statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Usage'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /billing/webhook:
    post:
      tags:
        - Billing
      summary: Stripe Webhook
      description: |
        Receives webhook events from Stripe for subscription lifecycle management.

        **Note:** This endpoint is called by Stripe, not by API consumers.
      operationId: stripeWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Stripe webhook event payload
      responses:
        '200':
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
        '400':
          description: Invalid webhook signature

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        API authentication using Bearer tokens.

        Include your API key in the Authorization header:
        ```
        Authorization: Bearer YOUR_API_KEY
        ```

  parameters:
    ProjectIdParam:
      name: projectId
      in: path
      required: true
      schema:
        type: string
      description: Unique project identifier
      example: proj_abc123xyz

    ScanIdParam:
      name: scanId
      in: path
      required: true
      schema:
        type: string
      description: Unique scan identifier
      example: scan_xyz789abc

    PageParam:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
      description: Page number for pagination

    LimitParam:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
      description: Number of items per page

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Bad Request
            message: Invalid project name

    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Unauthorized
            message: Invalid or expired API key

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Not Found
            message: Project not found

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Internal Server Error
            message: An unexpected error occurred

  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - service
      properties:
        status:
          type: string
          enum: [ok, degraded, down]
          description: Current service status
        service:
          type: string
          description: Service name

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error details

    Project:
      type: object
      required:
        - id
        - name
        - organizationId
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          description: Unique project identifier
          example: proj_abc123xyz
        name:
          type: string
          description: Project name
          example: Payment Gateway API
        specUrl:
          type: string
          format: uri
          description: URL to OpenAPI specification
          example: https://api.example.com/openapi.yaml
        specContent:
          type: string
          description: Raw OpenAPI specification content
        organizationId:
          type: string
          description: Organization ID
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp

    ProjectWithScans:
      allOf:
        - $ref: '#/components/schemas/Project'
        - type: object
          properties:
            scans:
              type: array
              items:
                $ref: '#/components/schemas/Scan'
              description: Recent scans for this project

    CreateProjectRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: Project name
          example: Payment Gateway API
        specUrl:
          type: string
          format: uri
          description: URL to fetch OpenAPI specification
        specContent:
          type: string
          description: Raw OpenAPI specification (JSON or YAML)

    Scan:
      type: object
      required:
        - id
        - projectId
        - status
        - startedAt
      properties:
        id:
          type: string
          description: Unique scan identifier
          example: scan_xyz789abc
        projectId:
          type: string
          description: Associated project ID
        status:
          type: string
          enum: [PENDING, PROCESSING, COMPLETED, FAILED]
          description: Current scan status
        startedAt:
          type: string
          format: date-time
          description: Scan start timestamp
        completedAt:
          type: string
          format: date-time
          description: Scan completion timestamp

    ScanWithFindings:
      allOf:
        - $ref: '#/components/schemas/Scan'
        - type: object
          properties:
            findings:
              type: array
              items:
                $ref: '#/components/schemas/Finding'
              description: Security findings from the scan

    Finding:
      type: object
      required:
        - id
        - scanId
        - type
        - severity
        - description
        - endpoint
        - method
        - createdAt
      properties:
        id:
          type: string
          description: Unique finding identifier
        scanId:
          type: string
          description: Associated scan ID
        type:
          type: string
          description: Vulnerability type
          example: Broken Object Level Authorization
        severity:
          type: string
          enum: [CRITICAL, HIGH, MEDIUM, LOW, INFO]
          description: Finding severity level
        description:
          type: string
          description: Detailed vulnerability description
        endpoint:
          type: string
          description: Affected API endpoint
          example: /api/users/{id}
        method:
          type: string
          enum: [GET, POST, PUT, PATCH, DELETE, HEAD, OPTIONS]
          description: HTTP method
        remediation:
          type: string
          description: Recommended fix with code examples
        owaspCategory:
          type: string
          description: OWASP API Top 10 category
          example: 'API1:2023 - Broken Object Level Authorization'
        cweId:
          type: string
          description: CWE identifier
          example: CWE-639
        evidence:
          type: string
          description: Evidence supporting the finding
        createdAt:
          type: string
          format: date-time
          description: Finding creation timestamp

    Plan:
      type: object
      required:
        - id
        - name
        - price
        - interval
        - scansPerMonth
        - projectLimit
        - features
      properties:
        id:
          type: string
          description: Plan identifier
        name:
          type: string
          description: Plan name
          example: Pro
        stripePriceId:
          type: string
          description: Stripe Price ID
        price:
          type: number
          format: float
          description: Price in USD
          example: 49.00
        interval:
          type: string
          enum: [month, year]
          description: Billing interval
        scansPerMonth:
          type: integer
          description: Monthly scan quota
          example: 100
        projectLimit:
          type: integer
          description: Maximum number of projects
          example: 10
        features:
          type: array
          items:
            type: string
          description: Included features
          example:
            - Unlimited team members
            - Priority support
            - Custom integrations
        isActive:
          type: boolean
          description: Whether plan is available for purchase

    Subscription:
      type: object
      required:
        - id
        - userId
        - status
        - planId
      properties:
        id:
          type: string
          description: Subscription identifier
        userId:
          type: string
          description: User ID
        stripeSubscriptionId:
          type: string
          description: Stripe Subscription ID
        stripePriceId:
          type: string
          description: Stripe Price ID
        status:
          type: string
          enum: [active, canceled, past_due, trialing, incomplete]
          description: Subscription status
        planId:
          type: string
          description: Plan ID
        plan:
          $ref: '#/components/schemas/Plan'
        currentPeriodStart:
          type: string
          format: date-time
          description: Current billing period start
        currentPeriodEnd:
          type: string
          format: date-time
          description: Current billing period end
        cancelAtPeriodEnd:
          type: boolean
          description: Whether subscription will cancel at period end

    Usage:
      type: object
      required:
        - scansUsed
        - scansLimit
        - projectsUsed
        - projectsLimit
      properties:
        scansUsed:
          type: integer
          description: Scans used this billing period
          example: 45
        scansLimit:
          type: integer
          description: Monthly scan quota
          example: 100
        projectsUsed:
          type: integer
          description: Number of active projects
          example: 3
        projectsLimit:
          type: integer
          description: Maximum projects allowed
          example: 10
        periodStart:
          type: string
          format: date-time
          description: Current period start date
        periodEnd:
          type: string
          format: date-time
          description: Current period end date
